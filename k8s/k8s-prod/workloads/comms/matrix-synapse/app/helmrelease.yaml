---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: matrix-synapse
  namespace: comms
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://ananace.gitlab.io/charts
      chart: matrix-synapse
      version: 3.2.9
      sourceRef:
        kind: HelmRepository
        name: ananace-charts
        namespace: flux-system
      interval: 5m
  values:
    image:
      repository: ghcr.io/matrix-org/synapse
      tag: v1.84.1
    serverName: &serverName "${SECRET_DOMAIN_WORK}"
    publicServerName: &publicServerName matrix."${SECRET_DOMAIN_WORK}"
    wellknown:
      enabled: true
    synapse:
      tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule
    workers:
      enabled: true
      tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule

      generic_worker:
        enabled: true

      federation_sender:
        enabled: true

      media_repository:
        enabled: false

    extraConfig:
      email:
        smtp_host: "${SMTP_RELAY_HOST}"
        smtp_port: "${SMTP_RELAY_PORT}"
        notif_from: "Matrix <${SECRET_SMTP_FROM_FULL}>"
      enable_3pid_lookup: false
      enable_registration: false
      disable_msisdn_registration: true

    ingress:
      enabled: true
      className: nginx-internal
      annotations:
        external-dns.home.arpa/enabled: "true"
        external-dns.alpha.kubernetes.io/target: "ingress.${SECRET_DOMAIN}"
        nginx.ingress.kubernetes.io/proxy-body-size: 1G
        nginx.ingress.kubernetes.io/enable-global-auth: "false"
        nginx.ingress.kubernetes.io/enable-cors: "true"
        nginx.ingress.kubernetes.io/cors-allow-headers: "X-Forwarded-For"
      tls:
        - secretName: "${SECRET_DOMAIN_WORK_CERT_SECRET}"
          hosts:
            - *serverName
            - *publicServerName

    postgresql:
      enabled: false

    externalPostgresql:
      port: 5432
      # host: provided in valuesFrom
      # username: provided in valuesFrom
      # database: provided in valuesFrom
      existingSecret: database-matrix-synapse-user
      existingSecretPasswordKey: PASSWORD

    redis:
      enabled: true
      auth:
        enabled: true
        # key redis-password
        existingSecret: matrix-synapse-secret

    signingkey:
      job:
        enabled: false
      existingSecret: matrix-synapse-secret
      existingSecretKey: signing-key

    persistence:
      enabled: true
      existingClaim: matrix-synapse-data
  valuesFrom:
    - kind: Secret
      name: database-matrix-synapse-user
      valuesKey: HOST
      targetPath: externalPostgresql.host
    - kind: Secret
      name: database-matrix-synapse-user
      valuesKey: DATABASE_NAME
      targetPath: externalPostgresql.database
    - kind: Secret
      name: database-matrix-synapse-user
      valuesKey: LOGIN
      targetPath: externalPostgresql.username
    - kind: Secret
      name: database-matrix-synapse-user
      valuesKey: PASSWORD
      targetPath: externalPostgresql.password
    - kind: Secret
      name: database-matrix-synapse-user
      valuesKey: HOST
      targetPath: externalPostgresql.username
