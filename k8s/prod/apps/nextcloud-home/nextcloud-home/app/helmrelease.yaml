---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: ${APP}
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 2.6.0
      interval: 15m
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 1
  uninstall:
    keepHistory: false
  values:
    controllers:
      main:
        annotations:
          reloader.stakater.com/auto: "true"
        pod:
          securityContext:
            runAsUser: 2000
            runAsGroup: 2000
            fsGroup: 2000
        containers:
          main:
            image:
              repository: docker.io/nextcloud/aio-apache
              tag: beta
            env:
              TZ: "${SECRET_TIMEZONE}"
              ADDITIONAL_TRUSTED_DOMAIN:
              APACHE_MAX_SIZE: 10737418240
              APACHE_MAX_TIME: &MAX_TIME 3600
              APACHE_PORT: &APACHE_PORT 10001
              COLLABORA_HOST: &COLLABORA_HOST ${APP}-collabora.${APP_NS}.svc.cluster.local
              NC_DOMAIN: "${NC_DOMAIN}"
              NEXTCLOUD_HOST: &NEXTCLOUD_HOST ${APP}-nextcloud.${APP_NS}.svc.cluster.local
              NOTIFY_PUSH_HOST: &NOTIFY_PUSH_HOST ${APP}-notifypush.${APP_NS}.svc.cluster.local
              ONLYOFFICE_HOST: &ONLYOFFICE_HOST ${APP}-onlyoffice.${APP_NS}.svc.cluster.local
              IMAGINARY_HOST: &IMAGINARY_HOST ${APP}-imaginary.${APP_NS}.svc.cluster.local
      collabora:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          collabora:
            image:
              repository: docker.io/nextcloud/aio-collabora
              tag: 20240201_120631-latest
            env:
              TZ: "${SECRET_TIMEZONE}"
              DONT_GEN_SSL_CERT: "1"
              aliasgroup1: https://${NC_DOMAIN}
              dictionaries: "de_DE en_US es_ES"
              extra_params: --o:ssl.enable=false --o:ssl.termination=true --o:mount_jail_tree=false --o:logging.level=warning --o:home_mode.enable=true {{ .Values.COLLABORA_SECCOMP_POLICY }} --o:remote_font_config.url=https://${NC_DOMAIN}/apps/richdocuments/settings/fonts.json
              server_name: "${NC_DOMAIN}"
            securityContext:
              capabilities:
                add:
                  - MKNOD
      imaginary:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          imaginary:
            image:
              repository: docker.io/nextcloud/aio-imaginary
              tag: 20240201_120631-latest
            env:
              TZ: "${SECRET_TIMEZONE}"
      redis:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          redis:
            image:
              repository: docker.io/library/redis
              tag: "7"
            command: ["redis-server", "--requirepass", "$(REDIS_PASSWORD)"]
            env:
              REDIS_REPLICATION_MODE: master
              REDIS_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: ${APP}-secret
                    key: REDIS_HOST_PASSWORD

      nextcloud:
        annotations:
          reloader.stakater.com/auto: "true"
        #pod:
        #  securityContext:
        #    runAsUser: 2000
        #    runAsGroup: 2000
        #    fsGroup: 2000
        initContainers:
          init-volumes:
            image:
              repository: docker.io/library/alpine
              tag: 3
            command:
              - /bin/sh
              - -ec
              - |
                rm -rf /nextcloud-aio-nextcloud/lost+found && chmod 777 /nextcloud-aio-nextcloud
        containers:
          nextcloud:
            image:
              repository: docker.io/nextcloud/aio-nextcloud
              tag: beta
            # the upstream image is a hostile root-running uid-proscribing monstrosity
            command:
              - /bin/sh
              - -c
              - >
                 unset HOME &&
                 usermod -o -u $NEW_UID www-data &&
                 sed -i 's|#!/bin/bash|#!/bin/bash\nunset HOME\n|' /entrypoint.sh &&
                 sed -i 's/POSTGRES_USER="oc_\(.*\)"/POSTGRES_USER="\1"/' /start.sh &&
                 find /usr/local/etc -user $OLD_UID -exec chown $NEW_UID {} \; &&
                 /start.sh; sleep infinity
            env:
              OLD_UID: 33
              NEW_UID: 2000
              PGSSLROOTCERT: /usr/local/share/ca-certificates/pg-root.crt
              PGSSLMODE: verify-full
              TZ: "${SECRET_TIMEZONE}"
              SMTP_HOST: "${SMTP_RELAY_HOST}"
              SMTP_PORT: "${SMTP_RELAY_PORT}"
              SMTP_AUTHTYPE: ""
              SMTP_SECURE: ""
              SMTP_NAME: ""
              SMTP_PASSWORD: ""
              MAIL_FROM_ADDRESS: "${SECRET_SMTP_FROM_USER}"
              MAIL_DOMAIN: "${SECRET_DOMAIN}"
              APPS_ALLOWLIST: ""
              ADDITIONAL_TRUSTED_PROXY: ${CLUSTER_CIDR}
              ADDITIONAL_TRUSTED_DOMAIN: ""
              SERVERINFO_TOKEN: ""
              ADDITIONAL_APKS: imagemagick
              ADDITIONAL_PHP_EXTENSIONS: imagick
              APACHE_PORT: *APACHE_PORT
              CLAMAV_ENABLED: "no"
              CLAMAV_HOST: ""
              COLLABORA_ENABLED: "yes"
              COLLABORA_HOST: *COLLABORA_HOST
              FULLTEXTSEARCH_ENABLED: "no"
              FULLTEXTSEARCH_HOST: ""
              FULLTEXTSEARCH_PASSWORD: ""
              IMAGINARY_ENABLED: "yes"
              IMAGINARY_HOST: *IMAGINARY_HOST
              INSTALL_LATEST_MAJOR: "no"
              NC_DOMAIN: "${NC_DOMAIN}"
              NEXTCLOUD_DATA_DIR: /data
              ONLYOFFICE_ENABLED: "no"
              ONLYOFFICE_HOST: *ONLYOFFICE_HOST
              ONLYOFFICE_SECRET: ""
              OVERWRITEPROTOCOL: "https"
              PHP_MAX_TIME: *MAX_TIME
              PHP_MEMORY_LIMIT: "512m"
              PHP_UPLOAD_LIMIT: "10g"
              RECORDING_SECRET: ""
              REDIS_HOST: ${APP}-redis.${APP_NS}.svc.cluster.local
              REDIS_HOST_PORT: 6379
              REMOVE_DISABLED_APPS: "yes"
              SIGNALING_SECRET: ""
              STARTUP_APPS: deck twofactor_totp tasks calendar contacts notes
              TALK_ENABLED: "no"
              TALK_PORT: 3478
              TALK_RECORDING_ENABLED: "no"
              TALK_RECORDING_HOST: ""
              TRUSTED_CACERTS_DIR: ""
              TURN_SECRET: ""
              UPDATE_NEXTCLOUD_APPS: ""
            envFrom: &envFrom
              - secretRef:
                  name: ${APP}-db-secret
              - secretRef:
                  name: ${APP}-secret

    persistence:
      apache:
        enabled: true
        type: persistentVolumeClaim
        existingClaim: ${APP}-apache
        advancedMounts:
          main:
            main:
              - path: /mnt/data
      nextcloud:
        enabled: true
        type: persistentVolumeClaim
        existingClaim: ${APP}
        advancedMounts:
          nextcloud:
            nextcloud:
              - path: /var/www/html
            init-volumes:
              - path: /nextcloud-aio-nextcloud
          main:
            main:
              - path: /var/www/html
                readOnly: true

      redis:
        enabled: true
        type: persistentVolumeClaim
        existingClaim: ${APP}-redis
        advancedMounts:
          redis:
            redis:
              - path: /data

      data:
        enabled: true
        type: nfs
        server: ${SECRET_NFS_SERVER}
        path: /mnt/tank2/services/drive.${SECRET_DOMAIN}-2
        advancedMounts:
          nextcloud:
            nextcloud:
              - path: /data
                subPath: nextcloud/data-test

      trusted-cacerts:
        enabled: true
        type: secret
        name: app-db-cert
        items:
          - key: root.crt
            path: pg-root.crt
        advancedMounts:
          nextcloud:
            nextcloud:
              - path: /usr/local/share/ca-certificates
                readOnly: true

#      paperless:
#        enabled: true
#        type: nfs
#        server: ${SECRET_NFS_SERVER}
#        path: /mnt/tank2/services/paperless.${SECRET_DOMAIN_INTERNAL}
#        advancedMounts:
#          main:
#            main:
#              - path: /paperless
#                readOnly: true
#
#      post-start-sh:
#        enabled: true
#        type: configMap
#        name: ${APP}-extra-config
#        advancedMounts:
#          main:
#            main:
#              - path: /usr/local/bin/post-start.sh
#                subPath: post-start.sh
#                readOnly: true
#        defaultMode: 0750
#        items:
#          - key: post-start.sh
#            path: post-start.sh
#
#      upload-limit-ini:
#        enabled: true
#        type: configMap
#        name: ${APP}-extra-config
#        advancedMounts:
#          main:
#            main:
#              - path: /usr/local/etc/php-fpm.d/uploadLimit.ini
#                subPath: uploadLimit.ini
#                readOnly: true
#        items:
#          - key: uploadLimit.ini
#            path: uploadLimit.ini

#      www-conf:
#        enabled: true
#        type: configMap
#        name: ${APP}-extra-config
#        advancedMounts:
#          main:
#            main:
#              - path: /usr/local/etc/php-fpm.d/zz-www.conf
#                subPath: www.conf
#                readOnly: true
#        items:
#          - key: www.conf
#            path: www.conf

      #opcache-recommended-ini:
      #  enabled: true
      #  type: configMap
      #  name: ${APP}-extra-config
      #  advancedMounts:
      #    main:
      #      main:
      #        - path: /usr/local/etc/php/conf.d/opcache-recommended.ini
      #          subPath: opcache-recommended.ini
      #          readOnly: true
      #  items:
      #    - key: opcache-recommended.ini
      #      path: opcache-recommended.ini
      #nextcloud-config:
      #  enabled: true
      #  type: configMap
      #  name: ${APP}-extra-config
      #  advancedMounts:
      #    main:
      #      main:
      #        - path: /var/www/html/config/extra.config.php
      #          subPath: extra.config.php
      #          readOnly: true
      #  items:
      #    - key: extra.config.php
      #      path: extra.config.php
      #redis-session-ini:
      #  enabled: true
      #  type: configMap
      #  name: ${APP}-extra-config
      #  advancedMounts:
      #    main:
      #      main:
      #        - path: /usr/local/etc/php/conf.d/redis-session.ini
      #          subPath: redis-session.ini
      #          readOnly: true
      #  items:
      #    - key: redis-session.ini
      #      path: redis-session.ini
      #nginx-config:
      #  enabled: true
      #  type: configMap
      #  name: ${APP}-nginx-config
      #  advancedMounts:
      #    main:
      #      nginx:
      #        - path: /etc/nginx/nginx.conf
      #          subPath: nginx.conf
      #          readOnly: true
      #  items:
      #    - key: nginx.conf
      #      path: nginx.conf

    ingress:
      main:
        enabled: true
        className: external
        annotations:
          external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
          nginx.ingress.kubernetes.io/proxy-body-size: 10G
          nginx.ingress.kubernetes.io/custom-http-errors: "418" # dummy status code to disable custom http errors
          nginx.ingress.kubernetes.io/enable-global-auth: "false"
          nginx.ingress.kubernetes.io/enable-cors: "true"
          nginx.ingress.kubernetes.io/cors-allow-headers: "X-Forwarded-For"
        hosts:
          - host: "${NC_DOMAIN}"
            paths:
              - path: /
                service:
                  name: main
                  port: http
        tls:
          - hosts:
              - "${NC_DOMAIN}"
    service:
      collabora:
        controller: collabora
        enabled: true
        primary: false
        ports:
          http:
            port: 9980
      imaginary:
        controller: imaginary
        enabled: true
        primary: false
        ports:
          http:
            port: 9000
      redis:
        controller: redis
        enabled: true
        primary: false
        ports:
          http:
            port: 6379
      nextcloud:
        controller: nextcloud
        enabled: true
        ports:
          php1:
            port: 9000
            protocol: TCP
          php2:
            port: 9001
            protocol: TCP
      main:
        controller: main
        ports:
          http:
            port: *APACHE_PORT
          udp:
            port: *APACHE_PORT
            protocol: UDP
